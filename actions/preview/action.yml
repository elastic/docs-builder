name: 'Documentation Preview'
description: 'Builds and publishes documentation to preview environment'

branding:
  icon: 'filter'
  color: 'red'

inputs:
  strict:
    description: 'Whether to fail the build if there are any warnings'
    default: true
    required: false

runs:
  using: "composite"
  steps:
    - name: Get types
      id: type
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "pull_request_target" && "${{ github.event.action }}" == "closed" ]]; then
          echo "IS_CLEANUP=true" >> $GITHUB_OUTPUT
          echo "IS_DEPLOYMENT=false" >> $GITHUB_OUTPUT
        elif [[ ${{ github.event_name }} == 'pull_request' || ("${{ github.event_name }}" == 'push' && "${{ github.ref }}" == 'refs/heads/main') ]]; then
          echo "IS_CLEANUP=false" >> $GITHUB_OUTPUT
          echo "IS_DEPLOYMENT=true" >> $GITHUB_OUTPUT
        fi

    - name: Debug
      shell: bash
      run: |
        echo "IS_DEPLOYMENT: ${{ steps.type.outputs.IS_DEPLOYMENT }}"
        echo "IS_CLEANUP: ${{ steps.type.outputs.IS_CLEANUP }}"

    - name: Authenticate 
      uses: elastic/docs-builder/.github/actions/aws-auth@main

    - name: Cleanup
      if: steps.type.outputs.IS_CLEANUP == 'true'
      shell: bash
      run: |
        aws s3 rm "s3://elastic-docs-v3-website-preview/${GITHUB_REPOSITORY}/pull/${PR_NUMBER}" --recursive

    - name: Delete GitHub environment
      if: steps.type.outputs.IS_CLEANUP == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const deployments = await github.rest.repos.listDeployments({
            owner,
            repo,
            environment: `docs-preview-${context.issue.number}`,
            per_page: 100,
          });
          for (const deployment of deployments.data) {
            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id: deployment.id,
              state: 'inactive',
              description: 'Marking deployment as inactive'
            });
            await github.rest.repos.deleteDeployment({
              owner,
              repo,
              deployment_id: deployment.id
            });
          }

    - name: Create Deployment
      if: steps.type.outputs.IS_DEPLOYMENT == 'true'
      uses: actions/github-script@v7
      id: deployment
      with:
        result-encoding: string
        script: |
          const { owner, repo } = context.repo;
          const branch = context.payload.pull_request
            ? context.payload.pull_request.head.ref 
            : context.ref.replace('refs/heads/', '');

          const repoResponse = await github.rest.repos.get({
            owner,
            repo
          })
          const defaultBranch = repoResponse.data.default_branch;
          const isDefaultBranch = branch === defaultBranch;

          const environment = isDefaultBranch
            ? `docs-preview-${defaultBranch}`
            : `docs-preview-${context.issue.number}`;

          const logUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

          const deployment = await github.rest.repos.createDeployment({
              owner,
              repo,
              ref: branch,
              environment,
              auto_merge: false,
              required_contexts: [],
          })
          await github.rest.repos.createDeploymentStatus({
              deployment_id: deployment.data.id,
              owner,
              repo,
              state: "in_progress",
              log_url: logUrl,
          })
          return deployment.data.id

    - name: Generate Path Prefix
      if: steps.type.outputs.IS_DEPLOYMENT == 'true'
      id: path-prefix
      shell: bash
      run: |
        if [[ -n "${{ github.event.pull_request }}" ]]; then
          echo "result=/${GITHUB_REPOSITORY}/pull/${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        else
          echo "result=/${GITHUB_REPOSITORY}/tree/${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi

    - name: Build public documentation
      if: steps.type.outputs.IS_DEPLOYMENT == 'true'
      uses: elastic/docs-builder@main
      continue-on-error: ${{ inputs.strict != 'true' }} # Will be removed after the migration phase
      with:
        prefix: ${{ steps.path-prefix.outputs.result }}
        strict: ${{ inputs.strict }}

    - name: Upload artifact
      if: steps.type.outputs.IS_DEPLOYMENT == 'true'
      shell: bash
      run: |
        aws s3 sync .artifacts/docs/html s3://elastic-docs-v3-website-preview${{steps.path-prefix.outputs.result}} --delete --quiet
        aws cloudfront create-invalidation --distribution-id EKT7LT5PM8RKS --paths "${{steps.path-prefix.outputs.result}}/*"

    - name: Update deployment status
      uses: actions/github-script@v7
      if: always() && steps.deployment.outputs.result
      with:
        script: |
          await github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: ${{ steps.deployment.outputs.result }},
            state: '${{ job.status == 'success' && 'success' || 'failure' }}',
            environment_url: `https://docs-v3-preview.elastic.dev${{steps.path-prefix.outputs.result}}`,
            log_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
            description: "Deployment completed",
          })
