---
name: Deploy MCP Lambda

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'edge'
        type: choice
        options:
          - edge
          - staging
          - prod
      ref:
        description: 'Git ref to deploy'
        required: false
        type: string
        default: ''
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      ref:
        required: false
        type: string
        default: ''

permissions:
  id-token: write
  contents: read

jobs:
  build:
    uses: ./.github/workflows/build-mcp-lambda.yml
    with:
      ref: ${{ inputs.ref || github.ref }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      LAMBDA_FUNCTION_NAME: elastic-docs-v3-mcp-${{ inputs.environment }}
      AWS_REGION: us-east-2
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v6
        with:
          name: mcp-lambda-binary
          path: ./artifact

      - name: Package Lambda
        run: |
          cd artifact
          chmod +x bootstrap
          zip -j ../function.zip bootstrap

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/elastic-docs-v3-mcp-deployer-${{ inputs.environment }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to Lambda
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --zip-file fileb://function.zip \
            --region ${{ env.AWS_REGION }}

      - name: Wait for update
        run: |
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Publish version
        id: publish
        run: |
          VERSION=$(aws lambda publish-version \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Version' --output text)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Published Lambda version: $VERSION"
