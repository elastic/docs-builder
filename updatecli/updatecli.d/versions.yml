---
name: Bump release versions in the config/versions.yml

scms:
  githubConfig:
    kind: github
    spec:
      user: '{{ requiredEnv "GITHUB_ACTOR" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      owner: '{{ .scm.owner }}'
      repository: '{{ .scm.repository }}'
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      commitusingapi: true
      branch: '{{ .scm.branch }}'
      force: false

actions:
  elastic-agent:
    kind: github/pullrequest
    scmid: githubConfig
    spec:
      automerge: false
      labels:
        - dependencies
      title: '[Automation] Bump EDOT versions'

sources:
  latest-edot-android-version:
    name: Get latest release version for the apm-agent-android
    kind: githubrelease
    transformers:
      - trimprefix: v
    spec:
      owner: elastic
      repository: apm-agent-android
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      versionfilter:
        kind: latest

  latest-edot-collector-version:
    name: Get latest major release version for the elastic-agent
    kind: githubrelease
    transformers:
      - trimprefix: v
    spec:
      owner: elastic
      repository: elastic-agent
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      versionFilter:
        kind: regex
        pattern: "v9.(\\d*).(\\d*)$"

  latest-edot-dotnet-version:
    name: Get latest release version for the elastic-otel-dotnet
    kind: githubrelease
    transformers:
      - trimprefix: v
    spec:
      owner: elastic
      repository: elastic-otel-dotnet
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      versionfilter:
        kind: latest

  latest-edot-ios-version:
    name: Get latest release version for the apm-agent-ios
    kind: githubrelease
    transformers:
      - trimprefix: v
    spec:
      owner: elastic
      repository: apm-agent-ios
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      versionfilter:
        kind: latest

  latest-edot-java-version:
    name: Get latest release version for the elastic-otel-java
    kind: githubrelease
    transformers:
      - trimprefix: v
    spec:
      owner: elastic
      repository: elastic-otel-java
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      versionfilter:
        kind: latest

  latest-edot-node-version:
    name: Get latest release version for the elastic-otel-node
    kind: githubrelease
    transformers:
      - trimprefix: v
    spec:
      owner: elastic
      repository: elastic-otel-node
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      versionFilter:
        kind: regex
        pattern: "^v(\\d*).(\\d*).(\\d*)$"

  latest-edot-php-version:
    name: Get latest release version for the elastic-otel-php
    kind: githubrelease
    transformers:
      - trimprefix: v
    spec:
      owner: elastic
      repository: elastic-otel-php
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      versionfilter:
        kind: latest

  latest-edot-python-version:
    name: Get latest release version for the elastic-otel-python
    kind: githubrelease
    transformers:
      - trimprefix: v
    spec:
      owner: elastic
      repository: elastic-otel-python
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      versionfilter:
        kind: latest

targets:
  update-docs-docset-android:
    name: 'Update config/versions.yml edot-android {{ source "latest-edot-android-version" }}'
    scmid: githubConfig
    sourceid: latest-edot-android-version
    kind: file
    spec:
      file: config/versions.yml
      matchpattern: '(edot_android:\s+base:\s+[\d\.]+\s+current:)\s+(.+)'
      replacepattern: '$1 {{ source "latest-edot-android-version" }}'

  update-docs-docset-collector:
    name: 'Update config/versions.yml edot-collector {{ source "latest-edot-collector-version" }}'
    scmid: githubConfig
    sourceid: latest-edot-collector-version
    kind: file
    spec:
      file: config/versions.yml
      matchpattern: '(edot_collector:\s+base:\s+[\d\.]+\s+current:)\s+(.+)'
      replacepattern: '$1 {{ source "latest-edot-collector-version" }}'

  update-docs-docset-dotnet:
    name: 'Update config/versions.yml edot-dotnet {{ source "latest-edot-dotnet-version" }}'
    scmid: githubConfig
    sourceid: latest-edot-dotnet-version
    kind: file
    spec:
      file: config/versions.yml
      matchpattern: '(edot_dotnet:\s+base:\s+[\d\.]+\s+current:)\s+(.+)'
      replacepattern: '$1 {{ source "latest-edot-dotnet-version" }}'

  update-docs-docset-ios:
    name: 'Update config/versions.yml edot-ios {{ source "latest-edot-ios-version" }}'
    scmid: githubConfig
    sourceid: latest-edot-ios-version
    kind: file
    spec:
      file: config/versions.yml
      matchpattern: '(edot_ios:\s+base:\s+[\d\.]+\s+current:)\s+(.+)'
      replacepattern: '$1 {{ source "latest-edot-ios-version" }}'

  update-docs-docset-java:
    name: 'Update config/versions.yml edot-java {{ source "latest-edot-java-version" }}'
    scmid: githubConfig
    sourceid: latest-edot-java-version
    kind: file
    spec:
      file: config/versions.yml
      matchpattern: '(edot_java:\s+base:\s+[\d\.]+\s+current:)\s+(.+)'
      replacepattern: '$1 {{ source "latest-edot-java-version" }}'

  update-docs-docset-node:
    name: 'Update config/versions.yml edot-node {{ source "latest-edot-node-version" }}'
    scmid: githubConfig
    sourceid: latest-edot-node-version
    kind: file
    spec:
      file: config/versions.yml
      matchpattern: '(edot_node:\s+base:\s+[\d\.]+\s+current:)\s+(.+)'
      replacepattern: '$1 {{ source "latest-edot-node-version" }}'

  update-docs-docset-php:
    name: 'Update config/versions.yml edot-php {{ source "latest-edot-php-version" }}'
    scmid: githubConfig
    sourceid: latest-edot-php-version
    kind: file
    spec:
      file: config/versions.yml
      matchpattern: '(edot_php:\s+base:\s+[\d\.]+\s+current:)\s+(.+)'
      replacepattern: '$1 {{ source "latest-edot-php-version" }}'

  update-docs-docset-python:
    name: 'Update config/versions.yml edot-python {{ source "latest-edot-python-version" }}'
    scmid: githubConfig
    sourceid: latest-edot-python-version
    kind: file
    spec:
      file: config/versions.yml
      matchpattern: '(edot_python:\s+base:\s+[\d\.]+\s+current:)\s+(.+)'
      replacepattern: '$1 {{ source "latest-edot-python-version" }}'