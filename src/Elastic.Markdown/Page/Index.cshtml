@using System.Text.Json
@using Elastic.Documentation
@using Elastic.Documentation.Configuration
@using Elastic.Documentation.Extensions
@using Elastic.Documentation.Site
@using Elastic.Markdown
@using Elastic.Markdown.Myst.Components
@using Markdig
@using ViewModelSerializerContext = Elastic.Markdown.Page.ViewModelSerializerContext
@inherits RazorSliceHttpResult<Elastic.Markdown.Page.IndexViewModel>
@implements IUsesLayout<Elastic.Markdown._Layout, MarkdownLayoutViewModel>
@functions {
	static string GetRootPath(string? siteRootPath, string? urlPathPrefix)
	{
		if (!string.IsNullOrEmpty(siteRootPath))
			return siteRootPath;
		var prefix = urlPathPrefix?.Trim('/') ?? "";
		return string.IsNullOrEmpty(prefix) ? "/" : $"/{prefix}/";
	}

	public MarkdownLayoutViewModel LayoutModel => new()
	{
		DocsBuilderVersion = ShortId.Create(BuildContext.Version),
		Layout = Model.CurrentDocument.YamlFrontMatter?.Layout,
		RenderHamburgerIcon = Model.CurrentDocument.YamlFrontMatter?.Layout != MarkdownPageLayout.LandingPage,
		DocSetName = Model.DocSetName,
		Title = $"{Model.Title} | {Model.SiteName}",
		Description = Model.Description,
		PageTocItems = Model.PageTocItems.Where(i => i is
			{
				Level: 2 or 3
			})
			.ToList(),
		CurrentNavigationItem = Model.CurrentNavigationItem,
		Previous = Model.PreviousDocument,
		Next = Model.NextDocument,
		NavigationHtml = Model.NavigationHtml,
		UrlPathPrefix = Model.UrlPathPrefix,
		GithubEditUrl = Model.GithubEditUrl,
		MarkdownUrl = Model.MarkdownUrl,
		BuildType = Model.BuildType,
		HideEditThisPage = Model.Features.DisableGitHubEditLink && Model.BuildType != BuildType.Isolated,
		AllowIndexing = Model.AllowIndexing,
		CanonicalBaseUrl = Model.CanonicalBaseUrl,
		GoogleTagManager = Model.GoogleTagManager,
		Optimizely = Model.Optimizely,
		Features = Model.Features,
		StaticFileContentHashProvider = Model.StaticFileContentHashProvider,
		ReportIssueUrl = Model.ReportIssueUrl,
		Breadcrumbs = Model.Breadcrumbs,
		Htmx = Model.BuildType == BuildType.Codex
			? (IHtmxAttributeProvider)new CodexHtmxAttributeProvider(GetRootPath(Model.SiteRootPath, Model.UrlPathPrefix))
			: new DefaultHtmxAttributeProvider(GetRootPath(Model.SiteRootPath, Model.UrlPathPrefix)),
		CurrentVersion = Model.CurrentDocument.YamlFrontMatter?.Layout == MarkdownPageLayout.LandingPage ? Model.VersionsConfig.VersioningSystems[0].Current : Model.CurrentVersion,
		AllVersionsUrl = Model.AllVersionsUrl,
		VersioningSystem = Model.VersioningSystem,
		VersionDropdownSerializedModel = JsonSerializer.Serialize(Model.VersionDropdownItems,
			ViewModelSerializerContext.Default.VersionDropDownItemViewModelArray),
		// Header properties for isolated mode
		HeaderTitle = Model.DocSetName,
		HeaderVersion = null,
		GitBranch = Model.GitBranch,
		GitCommitShort = Model.GitCommitShort,
		GitRepository = Model.GitRepository,
		GitHubDocsUrl = Model.GitHubDocsUrl,
		GitHubRef = Model.GitHubRef,
	};
	protected override Task ExecuteSectionAsync(string name)
	{
		if (name == GlobalSections.Head)
		{
			<meta class="elastic" name="product_version" content="@(new HtmlString(Model.CurrentVersion))"/>
			<meta name="DC.identifier" content="@(new HtmlString(Model.CurrentVersion))"/>
			<link rel="alternate" type="text/markdown" href="@(Model.MarkdownUrl)" title="Markdown export"/>
			<script type="application/ld+json">
	    	@(new HtmlString(Model.StructuredBreadcrumbsJson))
	    	</script>
		}
		if (name == GlobalSections.Head && Model.Products is { Count: > 0 })
		{
			var products = string.Join(",", Model.Products.Select(p => p.DisplayName));
			<meta class="elastic" name="product_name" content="@(products)"/>
			<meta name="DC.subject" content="@(products)"/>
		}
		return Task.CompletedTask;
	}
}
<section id="elastic-docs-v3">
	@* This way it's correctly rendered as <h1>text</h1> instead of <h1><p>text</p></h1> *@
	@(new HtmlString(Markdown.ToHtml("# " + Model.TitleRaw)))
	@if (Model.AppliesTo is not null)
	{
		<p class="applies applies-block">
		@await RenderPartialAsync(ApplicableToComponent.Create(new ApplicableToViewModel
		{
			AppliesTo = Model.AppliesTo,
			Inline = false,
			VersionsConfig = Model.VersionsConfig
		}))
		</p>
	}
	@(new HtmlString(Model.MarkdownHtml))
</section>
